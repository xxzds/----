<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">

    <title>优惠券详情页-促优网-专注独家正品折扣，返利-上促优，便宜购！</title>
    <meta content="促优网、返利、淘宝客、优惠券" name="keywords">
    <meta content="促优网专注独家折扣，每天精选上千款超值商品，天天更新，件件超值。商城优品超值买，优质大牌低价购，相信品牌的品质，购物就来促优网！" name="description">
    <link rel="shortcut icon" type="image/ico" href="./images/favicon.ico">
    <link rel="bookmark" href="./images/favicon.ico"/>

    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/dropload.css">
    <link rel="stylesheet" href="./css/amazeui.css">
    <link rel="stylesheet" href="./css/itemDetail.css">
</head>
<body>
<!--模板 img标签注意，防止浏览器加载一次模板中的src，报错-->
<div id="template" style="display: none">
    &lt;img src="${smallImage}"&gt;
</div>

<!--后退-->
<div class="nbleft" style="position: fixed; top: 15px; z-index: 99999; width: 100%; max-width: 46.875px; margin: 0px auto; left: 0px; right: 328.125px;">
    <a href="javascript:void(0);" onclick="javascript:history.back(-1);">
        <img src="./images/return.png" style="width:35px;float:left;margin-left:15px;">
    </a>
</div>

<!--图片分享-->
<div class="nbright" style="position: fixed; bottom: 105px; z-index: 99999; width: 100%; max-width: 46.875px; margin: 0px auto; left: 328.125px; right: 0px;">
    <a href="javascript:" class="nb-camera">
        <img src="./images/repic.png" style="width:35px;float:right;margin-right:15px;">
    </a>
</div>

<!--content-->
<div class="container">
    <div class="row">
        <div id="big-image"><img src="" class="img-responsive"></div>
    </div>

    <div>
        <div id="title"><h4 style="margin-top: 10px;margin-bottom: 10px;line-height: 1.8;"></h4></div>
        <div class="fq-color-danger" style="margin: 10px 0;">
            <span class="am-text-xs">券后包邮</span>
            <span class="am-text-default"><strong id="couponPrice"></strong></span>
        </div>
    </div>


    <div class="row" style="margin-bottom: 10px;">
        <div class="col-md-4 col-sm-4 col-xs-4 am-text-xs">现价<span class="line fq-color-gray" id="price"></span></div>
        <div class="col-md-4 col-sm-4 col-xs-4 am-text-xs">优惠券<span id="quan"></span></div>
        <div class="col-md-4 col-sm-4 col-xs-4 am-text-xs">销量<span id="volume"></span></div>
    </div>

    <!--图片-->
    <div id="detailItem">
        <strong>商品详情</strong>
    </div>
    <div id="images" class="row thumbnail"></div>


    <canvas id="tutorial" width="300px" height="600px"></canvas>
    <!--&lt;!&ndash;图片合成&ndash;&gt;-->
    <!--<div class="camera">-->
        <!--图片合成-->
    <!--</div>-->


    <!--分享图片-->
    <div class="nb-sharecanvas" style="display: none;">
        <div class="nb-canvas">

            <i class="icon-close" style=""></i>
            <canvas id="sharecanvas" style="background-color:white;display:none; width:80%" class="am-text-center am-center" width="675" height="1017"></canvas>

            <img src="" class="imgData" check-src="true" background="white" style="display: inline;">
            <div class="nb-canvas-explain am-text-sm nb-text-white am-margin-top-sm am-padding-xs">
                <span class="image_loading" style="display:none;color:#fff;font-size:13px;line-height:15px;padding-top:10px;padding-bottom:10px;text-align:center"><i></i>图文合成中，请耐心稍等片刻</span>
                <span class="image_show" style="color:#fff;font-size:13px;text-align:center">  说明：长按上方图片发给朋友或保存图片。</span>
            </div>

        </div>
    </div>

    <!--二维码-->
    <!--<img id="codeimage" src=""/>-->





    <!--淘口令-->
    <div class="am-modal am-modal-no-btn am-modal-active" tabindex="-1" id="doc-modal-1" style="font-size: 12px;z-index: 9999999; display: none;">
        <div class="am-modal-dialog fq-background-white">
            <div class="am-modal-hd">
                口令购买
                <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close="">&times;</a>
            </div>
            <div class="am-modal-bd  am-padding-0">

                <!--口令-->
                <!--二合一口令开始-->

                <div class="am-margin-vertical am-margin-horizontal-lg">
                    <div class="fq-goods-border am-text-center am-margin-top am-padding-vertical am-padding-horizontal-sm fq-background-white" style="margin:0;">
                        <div class="fq-explain  am-center am-text-center">
                            <span class="am-padding-horizontal-sm fq-nowrap " style="color:white; background:#f54d23">长按框内 &gt; 拷贝</span>
                        </div>
                        <div id="copy_key_ios" class="more_ktl" style="font-size:16px;height:24px;line-height:24px;"></div>
                        <textarea style="display: none;height:40px;font-size:16px;line-height:24px;" id="copy_key_android" type="text" class="am-form-field am-text-center am-text-sm more_ktl" oninput="regain();"></textarea>
                    </div>
                </div>



                <!--二合一口令结束-->
                <div class="copy_taowords am-margin-bottom" style="">
                    <div class="share_content am-margin-bottom am-badge-success am-badge" id="share_content"></div>
                    <div class="am-text-center am-margin-top-sm ">
                        <a class="am-padding-vertical-xs am-padding-horizontal-lg am-round am-inline-block share" id="copybtn" style="background: #f54d23; color: white;" data-taowords="">一键复制</a>
                        <div class="am-margin-top-sm am-text-xs am-text-primary am-margin-horizontal-sm">点击复制后，请打开【手机APP】购买！</div>
                    </div>
                </div>
                <div class="am-text-left am-text-xs am-padding-vertical-sm am-padding-horizontal-lg" style="background:#f3f3f3; border-radius:0 0 5px 5px;color:#86564B">
                        <span>
						<span>使用说明：</span>
                            <span>复制口令后打开【手机APP】即可领取优惠券购买！</span>
                        </span>
                    <br>
                    <span>
						<span>温馨提示：</span>
                            手机无【手机APP】者，可选择浏览器购买方式哦~
                        </span>
                </div>

            </div>
        </div>
    </div>


    <!--footer-->
    <div class="footer">
        <a id="one">直接购买</a>
        <a id="two">淘口令分享</a>
    </div>
</div>





<script type="text/javascript" src="./js/jquery.min.js"></script>
<!--<script type="text/javascript" src="./js/jquery.cookie.js"></script>-->
<script type="text/javascript"  src="./js/getUrlParam.js"></script>
<script type="text/javascript" src="./js/amazeui.min.js"></script>
<script type="text/javascript" src="./js/clipboard.min.js"></script>
<script type="text/javascript">
    $(function() {
        $.ajax({
            type: "POST",
            url: "http://www.tooklili.com:81/tookApp/getitem/" + UrlParm.parm("id"),
            dataType: "json",
            success: function (result) {

                if(!result.success){
                    alert(result.message);
                    return;
                }
                var data = result.data;
                console.log(data);
                if(data==null || data.length<=0) {
                    alert("暂无数据");
                    return;
                }

                //主图
                $('#big-image>img').attr("src",data.picUrl);
                //标题
                $('#title>h4').html(data.title);
                //券后价
                $('#couponPrice').html('￥'+data.couponPrice);
                //现价
                $('#price').html('￥'+data.price);
                //优惠券
                $('#quan').html('￥'+data.quan);
                //销量
                $('#volume').html(data.volume);
                //直接购买
                $('.footer>#one').attr('href',data.quanUrl);

                //淘口令分享
                $('.footer>#two').click(function () {
                    getTpwd(data.title,data.quanUrl,data.picUrl)

                });

//                $('#codeimage').attr('src',"http://qr.liantu.com/api.php?text="+encodeURI(data.quanUrl));

            },
            error: function () {
                alert("网络异常");
            }
        });


        /**
         * 获取淘口令
         * @param text
         * @param url
         */
        function getTpwd(text,url,logo) {
            $.ajax({
                type: "POST",
                url: "http://www.tooklili.com:81/tookApp/tbk/getTPwd/",
                data:{
                    text:text,
                    url:url,
                    logo:logo
                },
                dataType: "json",
                success: function (result) {

                    if(!result.success){
                        alert(result.message);
                        return;
                    }
                    var data = result.data;
                    console.log(data);

                    //打开弹层
                    $('#doc-modal-1').modal({
                        relatedTarget: this,
                    });
                    $('#copy_key_android').val(data);
                    $('#copy_key_ios').html(data);
                    $("#copybtn").attr('data-taowords',data);



                },
                error: function () {
                    alert("网络异常");
                }
            });
        }




        $.ajax({
            type: "POST",
            url: "http://www.tooklili.com:81/tookApp/tbk/getItemDetail/" + UrlParm.parm("numIid"),
            dataType: "json",
            success: function (result) {

                if(!result.success){
                    alert(result.message);
                    return;
                }
                var data = result.data;
                console.log(data);
                if(data==null || data.length<=0) {
                    alert("暂无数据");
                    return;
                }

                //图片列表
                var template=$('#template').html();
                var html="";
                var smallImages = data.smallImages;
                for(var i=0;i<smallImages.length;i++){
                    html+=template.replace("${smallImage}",smallImages[i])
                        .replace("&lt;","<")
                        .replace("&gt;",">");
                }
                $('#images').html(html);

            },
            error: function () {
                alert("网络异常");
            }
        });



        $('#detailItem').click(function(){
            $('#images').slideToggle();
        })
    });

</script>

<script>
    var taokouling_value = document.getElementById("copy_key_android").value;
    function regain() {
        document.getElementById('copy_key_android').value = taokouling_value;
    }
</script>

<script>
    $(function(){

        var nbcopy = 1;

        $("#copybtn").on('click', function() {
            var taowords = $(this).attr('data-taowords');
            console.log(taowords);
            $('#share_content').html(taowords);
        });

        var ua = navigator.userAgent.toLowerCase();
        if (nbcopy==1){
            $('.copy_taowords').show();

            var clipboard=new Clipboard("#copybtn",{text:function(){return $(".share_content").html()}});clipboard.on("success",function(a){$('.taokaocopy').html("<img src='../addons/bsht_tbk/res/images/copyok.png'  style='width:80%;max-width:650px'>");a.trigger.innerHTML="复制成功";a.trigger.style.backgroundColor="#9ED29E";$('#copybtn').hide();a.trigger.style.borderColor="#9ED29E";$(".share_content").hide();console.info("Action:",a.action);console.info("Text:",a.text);console.info("Trigger:",a.trigger);a.clearSelection();
                setTimeout(function () {
                    $(".share").html('一键复制');
                    $(".share").css('backgroundColor','#f54d23');
                    $(".am-close").click();
                }, 2000);
            });clipboard.on("error",function(a){a.trigger.innerHTML="复制失败";setTimeout(function(){a.trigger.innerHTML="请手工复制"},1000);a.trigger.style.backgroundColor="#666";a.trigger.style.borderColor="#9ED29E";$(".share_content").hide();console.info("Action:",a.action);console.info("Text:",a.text);console.info("Trigger:",a.trigger);a.clearSelection();


            });


        }


        var ua = navigator.userAgent.toLowerCase();
        if (ua.match(/iphone/i) == "iphone" || ua.match(/ipad/i) == "ipad") {

            $('.fq-explain span').html("长按框内 > 拷贝");

        } else {
            $("#copy_key_ios").hide();
            $("#copy_key_android").show();
        }


        document.addEventListener("selectionchange", function(e) {
            if (window.getSelection().anchorNode.parentNode.id == 'copy_key_ios' || window.getSelection().anchorNode.id == 'copy_key_ios') {
                var key = document.getElementById('copy_key_ios');
                window.getSelection().selectAllChildren(key)
            }
        }, false)

    });
</script>

<script>

    $(".nb-camera").click(function(){

        if($('.imgData').attr('src')==""){
            $('.image_loading').show();
            $('.image_show').hide();
        }
        canvasApp();
        $(".nb-sharecanvas").css("display","flex");


    });


    $(".nb-canvas .icon-close").click(function(){
        $(".nb-sharecanvas").css("display","none");
    });


    function canvasApp() {
        var canvas = document.getElementById('sharecanvas');
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = "#fff";
        canvas.width = (document.documentElement.clientWidth * 0.9) * 2;
        canvas.height = canvas.width / 2 + 680;
        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        for (var i = 0; i < imageData.data.length; i += 4) {
            if (imageData.data[i + 3] == 0) {
                imageData.data[i] = 255;
                imageData.data[i + 1] = 255;
                imageData.data[i + 2] = 255;
                imageData.data[i + 3] = 255;
            }
        }
        ctx.putImageData(imageData, 0, 0);
        var item_img = new Image()
        item_img.setAttribute('crossOrigin', 'anonymous');
        item_img.src = $('#big-image>img').attr("src");
        item_img.onerror = function () {
            $('.image_loading').hide();
            $('.image_show').hide();
            $('.nb-sharecanvas').hide();
            return false;
        }
        item_img.onload = function () {
            ctx.drawImage(item_img, 0, 0, canvas.width, canvas.width);
            var code_img = new Image();
            code_img.setAttribute('crossOrigin', 'anonymous');


//            $('#codeimage').attr('src')
            code_img.src = $('#big-image>img').attr("src");
            code_img.onerror = function () {
                $('.image_loading').hide();
                $('.image_show').hide();
                $('.nb-sharecanvas').hide();
                return false;
            }
            code_img.onload = function () {
                ctx.drawImage(code_img, canvas.width - 220, canvas.width + 20, 200, 200);
                var str = $('#title>h4').html();
                ctx.fillStyle = '#605761';
                ctx.lineWidth = 1;
                ctx.textAlign = 'left';
                ctx.textBaseline = "top";
                ctx.font = '28px Helvetica';
                var lineWidth = 0;
                var canvasWidth = canvas.width - 60;
                var initHeight = canvas.width + 30;
                var lastSubStrIndex = 0;
                for (var i = 0; i <= str.length; i++) {
                    lineWidth += ctx.measureText(str[i]).width;
                    if (lineWidth > canvasWidth - 230) {
                        ctx.fillText(str.substring(lastSubStrIndex, i), 20, initHeight);
                        initHeight += 40;
                        lineWidth = 0;
                        lastSubStrIndex = i;
                    }
                    if (i == str.length - 1) {
                        ctx.fillText(str.substring(lastSubStrIndex, i + 1), 20, initHeight);
                    }
                }

                var price = "原价："+$('#couponPrice').html();
                ctx.fillStyle = '#aba0ac';
                ctx.textAlign = 'left';
                ctx.font = '30px Helvetica';
                ctx.textBaseline = "top";
                ctx.fillText(price, 20, initHeight + 30);
                ctx.strokeStyle = '#aba0ac';
                ctx.lineWidth = 2;
                ctx.moveTo(20, initHeight + 46);
                ctx.lineTo(200, initHeight + 46);
                ctx.stroke();
                var end_price_title = "券后价:";
                ctx.fillStyle = '#aba0ac';
                ctx.textAlign = 'left';
                ctx.font = '30px Helvetica';
                ctx.textBaseline = "top";
                ctx.fillText(end_price_title, 20, initHeight + 80);
                //券后价
                var end_price = $('#price').html();
                ctx.fillStyle = '#fba137';
                ctx.textAlign = 'left';
                ctx.font = '42px Helvetica';
                ctx.textBaseline = "top";
                ctx.fillText(end_price, 120, initHeight + 72);
                ctx.setLineDash([10, 5]);
                ctx.lineWidth = 1;
                ctx.strokeStyle = '#aba0ac';
                ctx.beginPath();
                ctx.moveTo(10, canvas.height - 50);
                ctx.lineTo(canvas.width - 10, canvas.height - 50);
                ctx.stroke();
                ctx.fillStyle = 'white'
                ctx.lineWidth = 0;
                ctx.beginPath();
                ctx.moveTo((canvas.width - 308) / 2 - 10, canvas.height - 64);
                ctx.lineTo((canvas.width - 308) / 2 + 320, canvas.height - 64);
                ctx.lineTo((canvas.width - 308) / 2 + 320, canvas.height - 46);
                ctx.lineTo((canvas.width - 308) / 2 - 10, canvas.height - 46);
                ctx.lineTo((canvas.width - 308) / 2 - 10, canvas.height - 64);
                ctx.fill();
                var code_title = '长按二维码识别查看商品';
                ctx.fillStyle = '#aba0ac';
                ctx.font = '28px Helvetica';
                ctx.fillText(code_title, (canvas.width - 308) / 2, canvas.height - 64);
                var image = new Image();
                image.setAttribute('crossOrigin', 'anonymous');
                image.src = canvas.toDataURL("img/jpeg");
                $(".imgData").attr("background", "white");
                $(".imgData").attr("src", image.src);
                //$(".imgData").attr("id",image.src);
                $(".imgData").show();

                if ($('.imgData').attr('src') != "") {
                    $('.image_loading').hide();
                    $('.image_show').show();
                    $('.am-icon-close').show();
                }

            }
        }

    }

</script>

</body>
</html>