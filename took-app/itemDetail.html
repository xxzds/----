<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">

    <title>优惠券详情页-促优网-专注独家正品折扣，返利-上促优，便宜购！</title>
    <meta content="促优网、返利、淘宝客、优惠券" name="keywords">
    <meta content="促优网专注独家折扣，每天精选上千款超值商品，天天更新，件件超值。商城优品超值买，优质大牌低价购，相信品牌的品质，购物就来促优网！" name="description">
    <link rel="shortcut icon" type="image/ico" href="./images/favicon.ico">
    <link rel="bookmark" href="./images/favicon.ico"/>

    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/dropload.css">
    <link rel="stylesheet" href="./css/itemDetail.css">
</head>
<body>
<!--模板 img标签注意，防止浏览器加载一次模板中的src，报错-->
<div id="template" style="display: none">
    &lt;img src="${smallImage}"&gt;
</div>

<!--content-->
<div class="container">
    <div class="row">
        <div id="big-image"><img src="" class="img-responsive"></div>
    </div>

    <div>
        <div id="title"><h4></h4></div>
        <div class="fq-color-danger" style="margin: 10px 0;">
            <span class="am-text-xs">券后包邮</span>
            <span class="am-text-default"><strong id="couponPrice"></strong></span>
        </div>
    </div>


    <div class="row" style="margin-bottom: 10px;">
        <div class="col-md-4 col-sm-4 col-xs-4 am-text-xs">现价<span class="line fq-color-gray" id="price"></span></div>
        <div class="col-md-4 col-sm-4 col-xs-4 am-text-xs">优惠券<span id="quan"></span></div>
        <div class="col-md-4 col-sm-4 col-xs-4 am-text-xs">销量<span id="volume"></span></div>
    </div>

    <!--图片-->
    <div id="detailItem">
        <strong>商品详情</strong>
    </div>
    <div id="images" class="row thumbnail"></div>


    <!--<canvas id="tutorial" width="300px" height="600px"></canvas>-->
    <!--&lt;!&ndash;图片合成&ndash;&gt;-->
    <!--<div class="camera">-->
        <!--图片合成-->
    <!--</div>-->


    <!--footer-->
    <div class="footer">
        <a id="one">直接购买</a>
        <a id="two">淘口令分享</a>
    </div>
</div>





<script type="text/javascript" src="./js/jquery.min.js"></script>
<!--<script type="text/javascript" src="./js/jquery.cookie.js"></script>-->
<script type="text/javascript"  src="./js/getUrlParam.js"></script>
<script type="text/javascript">
    $(function() {
        $.ajax({
            type: "POST",
            url: "http://www.tooklili.com:81/tookApp/getitem/" + UrlParm.parm("id"),
            dataType: "json",
            success: function (result) {

                if(!result.success){
                    alert(result.message);
                    return;
                }
                var data = result.data;
                console.log(data);
                if(data==null || data.length<=0) {
                    alert("暂无数据");
                    return;
                }

                //主图
                $('#big-image>img').attr("src",data.picUrl);
                //标题
                $('#title>h4').html(data.title);
                //券后价
                $('#couponPrice').html('￥'+data.couponPrice);
                //现价
                $('#price').html('￥'+data.price);
                //优惠券
                $('#quan').html('￥'+data.quan);
                //销量
                $('#volume').html(data.volume);
                //直接购买
                $('.footer>#one').attr('href',data.quanUrl);

                //淘口令分享
                $('.footer>#two').click(function () {
                    getTpwd(data.title,data.quanUrl)
                    
                });

            },
            error: function () {
                alert("网络异常");
            }
        });


        /**
         * 获取淘口令
         * @param text
         * @param url
         */
        function getTpwd(text,url) {
            $.ajax({
                type: "POST",
                url: "http://www.tooklili.com:81/tookApp/tbk/getTPwd/",
                data:{
                    text:text,
                    url:url
                },
                dataType: "json",
                success: function (result) {

                    if(!result.success){
                        alert(result.message);
                        return;
                    }
                    var data = result.data;


                    alert(data);

                },
                error: function () {
                    alert("网络异常");
                }
            });
        }




        $.ajax({
            type: "POST",
            url: "http://www.tooklili.com:81/tookApp/tbk/getItemDetail/" + UrlParm.parm("numIid"),
            dataType: "json",
            success: function (result) {

                if(!result.success){
                    alert(result.message);
                    return;
                }
                var data = result.data;
                console.log(data);
                if(data==null || data.length<=0) {
                    alert("暂无数据");
                    return;
                }

                //图片列表
                var template=$('#template').html();
                var html="";
                var smallImages = data.smallImages;
                for(var i=0;i<smallImages.length;i++){
                    html+=template.replace("${smallImage}",smallImages[i])
                        .replace("&lt;","<")
                        .replace("&gt;",">");
                }
                $('#images').html(html);

            },
            error: function () {
                alert("网络异常");
            }
        });



        $('#detailItem').click(function(){
            $('#images').slideToggle();
        })


        $('.camera').click(function () {

            $('#tutorial').show();

            var canvas  = document.getElementById("tutorial");
            var ctx = canvas .getContext("2d");
            var item_img = new Image();
            item_img.setAttribute('crossOrigin', 'anonymous');
            item_img.src =  $('#big-image>img').attr("src");
            item_img.onload = function () {
                console.log(canvas.width);
                ctx.drawImage(item_img, 0, 0, canvas.width, canvas.width);
            };
            item_img.onerror = function () {
                window.alert('图片加载失败，请重试');
            };

            /*商品标题*/
            var str=$('#title>h4').html();
            ctx.fillStyle='#605761';
            ctx.lineWidth=1;
            ctx.textAlign = 'left';
            ctx.textBaseline = "top";
            ctx.font = '12px Helvetica';
            var lineWidth = 0;
            var canvasWidth = canvas.width - 40;//计算canvas的宽度
            var initHeight= canvas.width + 10;//绘制字体距离canvas顶部初始的高度
            var lastSubStrIndex= 0; //每次开始截取的字符串的索引
            for(var i = 0;i <= str.length; i++){
                console.log(ctx.measureText(str[i]).width);
                lineWidth += ctx.measureText(str[i]).width;
                if(lineWidth > canvasWidth){
                    ctx.fillText(str.substring(lastSubStrIndex,i),20,initHeight);//绘制截取部分
                    initHeight += 30;//字体的高度
                    lineWidth = 0;
                    lastSubStrIndex = i;
                }
                if(i == str.length - 1 ){
                    ctx.fillText(str.substring(lastSubStrIndex,i + 1 ),20,initHeight);
                }
            }

            /*原价*/
            var price = '在售价：599.00';
            ctx.fillStyle = '#aba0ac';
            ctx.textAlign = 'left';
            ctx.font = '30px Helvetica';
            ctx.textBaseline = "top";
            ctx.fillText(price,20,initHeight + 30);

            /*删除线*/
            ctx.strokeStyle = '#aba0ac';
            ctx.lineWidth = 2; // 改变线的粗细
            ctx.moveTo(20, initHeight + 46); // 起始点
            ctx.lineTo(200, initHeight + 46); // 第二点(如果是一条直线的话，就是终点)
            ctx.stroke();

            /*在售标题*/
            var end_price_title = '下单价:';
            ctx.fillStyle = '#aba0ac';
            ctx.textAlign = 'left';
            ctx.font = '30px Helvetica';
            ctx.textBaseline = "top";
            ctx.fillText(end_price_title,20,initHeight + 80);

//            /*在售价格*/
//            var end_price = '449.00';
//            ctx.fillStyle = '#fba137';
//            ctx.textAlign = 'left';
//            ctx.font = '42px Helvetica';
//            ctx.textBaseline = "top";
//            ctx.fillText(end_price,140,initHeight + 72);
//
//            /*优惠券金额*/
//            var end_price = '券150元';
//            ctx.fillStyle = '#fba137';
//            ctx.textAlign = 'left';
//            ctx.font = '30px Helvetica';
//            ctx.textBaseline = "top";
//            ctx.fillText(end_price,220,initHeight + 30);
//
//            /*虚线*/
//            ctx.setLineDash([10,5]);
//            ctx.lineWidth = 1;
//            ctx.strokeStyle = '#aba0ac';
//            ctx.beginPath();
//            ctx.moveTo(10, canvas.height - 50);
//            ctx.lineTo(canvas.width - 10, canvas.height - 50 );
//            ctx.stroke();


        })


    });

</script>
</body>
</html>